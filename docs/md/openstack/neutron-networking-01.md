<p style="text-align: right">2024-03-22</p>

# Neutron Networking 관련 참고 (1)

# 1. 개요

OpenStack 환경에서 Network 생성부터 VM 생성까지 단계별로 Neutron에서 어떤 Network Namespace를 만드는지 확인한다.

# 2. 단계별 Network Namespace 생성 확인

## 2.1 Network 생성

추가적인 Network Namespace 생성 없음

## 2.2 Subnet 생성

CIDR를 172.16.31.0/24로 설정하여 Subnet을 생성한다.

### 2.2.1 ip netns list

DHCP Enabled인 경우 qdhcp-\* Network Network Namespace 생성된다.

```bash
## ip netns list (controller1 node)
$ ip netns list
qdhcp-c926d8cb-0b16-474c-96d3-4a0646096be3 (id: 6)     # 생성
```

### 2.2.2 qdhcp-\* Network Namespace

해당 Network Namespace의 route, ip address, iptables-save 를 확인한다. 아래의 라우팅 테이블에서 확인할 수 있듯이 기본 게이트웨이가 설정되어 있다.

```bash
## ip netns exec qdhcp-c926d8cb-0b16-474c-96d3-4a0646096be3 route
$ ip netns exec qdhcp-c926d8cb-0b16-474c-96d3-4a0646096be3 route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         172.16.31.1     0.0.0.0         UG    0      0        0 tapf926e9e5-44
172.16.31.0     0.0.0.0         255.255.255.0   U     0      0        0 tapf926e9e5-44
```

tapf926e9e5-44에 2개의 주소(172.16.31.2/24, 169.254.169.254/32)가 할당되어 있다.

```bash
## ip netns exec qdhcp-c926d8cb-0b16-474c-96d3-4a0646096be3 ip address (controller1 node)
$ ip netns exec qdhcp-c926d8cb-0b16-474c-96d3-4a0646096be3 ip address
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
224: tapf926e9e5-44: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether fa:16:3e:e6:4a:bd brd ff:ff:ff:ff:ff:ff
    inet 172.16.31.2/24 brd 172.16.31.255 scope global tapf926e9e5-44
       valid_lft forever preferred_lft forever
    inet 169.254.169.254/32 brd 169.254.169.254 scope global tapf926e9e5-44
       valid_lft forever preferred_lft forever
    inet6 fe80::a9fe:a9fe/128 scope link
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fee6:4abd/64 scope link
       valid_lft forever preferred_lft forever
```

```bash
## ip netns exec qdhcp-c926d8cb-0b16-474c-96d3-4a0646096be3 iptables-save (controller1 node)
$ ip netns exec qdhcp-c926d8cb-0b16-474c-96d3-4a0646096be3 iptables-save
# Generated by iptables-save v1.8.4 on Tue Oct 17 05:28:38 2023
*raw
:PREROUTING ACCEPT [4:380]
:OUTPUT ACCEPT [4:380]
:neutron-dhcp-age-OUTPUT - [0:0]
:neutron-dhcp-age-PREROUTING - [0:0]
-A PREROUTING -j neutron-dhcp-age-PREROUTING
-A OUTPUT -j neutron-dhcp-age-OUTPUT
COMMIT
# Completed on Tue Oct 17 05:28:38 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 05:28:38 2023
*mangle
:PREROUTING ACCEPT [4:380]
:INPUT ACCEPT [4:380]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [4:380]
:POSTROUTING ACCEPT [4:380]
:neutron-dhcp-age-FORWARD - [0:0]
:neutron-dhcp-age-INPUT - [0:0]
:neutron-dhcp-age-OUTPUT - [0:0]
:neutron-dhcp-age-POSTROUTING - [0:0]
:neutron-dhcp-age-PREROUTING - [0:0]
:neutron-dhcp-age-mark - [0:0]
-A PREROUTING -j neutron-dhcp-age-PREROUTING
-A INPUT -j neutron-dhcp-age-INPUT
-A FORWARD -j neutron-dhcp-age-FORWARD
-A OUTPUT -j neutron-dhcp-age-OUTPUT
-A POSTROUTING -j neutron-dhcp-age-POSTROUTING
-A neutron-dhcp-age-POSTROUTING -p udp -m udp --dport 68 -j CHECKSUM --checksum-fill
-A neutron-dhcp-age-PREROUTING -j neutron-dhcp-age-mark
COMMIT
# Completed on Tue Oct 17 05:28:38 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 05:28:38 2023
*filter
:INPUT ACCEPT [4:380]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [4:380]
:neutron-dhcp-age-FORWARD - [0:0]
:neutron-dhcp-age-INPUT - [0:0]
:neutron-dhcp-age-OUTPUT - [0:0]
:neutron-dhcp-age-local - [0:0]
:neutron-filter-top - [0:0]
-A INPUT -j neutron-dhcp-age-INPUT
-A FORWARD -j neutron-filter-top
-A FORWARD -j neutron-dhcp-age-FORWARD
-A OUTPUT -j neutron-filter-top
-A OUTPUT -j neutron-dhcp-age-OUTPUT
-A neutron-filter-top -j neutron-dhcp-age-local
COMMIT
# Completed on Tue Oct 17 05:28:38 2023
```

## 2.3 Router 생성

Router를 생성하여 Network Network Namespace의 상태를 확인한다.

### 2.3.1 ip netns list

라우터를 생성하면 snat-_, qrouter-_ Network Network Namespace 각각 생성된다.

```bash
## ip netns list (controller1 node)
$ ip netns list
qrouter-e602072f-be51-4c08-9709-135623c0e03b            # 생성
snat-e602072f-be51-4c08-9709-135623c0e03b (id: 41)      # 생성
qdhcp-c926d8cb-0b16-474c-96d3-4a0646096be3 (id: 6)
```

### 2.3.2 qdhcp-\* Network Namespace

해당 Network Namespace에 route, ip address, iptables-save에 특별한 변경사항은 없다.

### 2.3.3 snat-\* Network Namespace

해당 Network Namespace의 route, ip address, iptables-save 를 확인한다. 기본 게이트웨이가 Public Network의 게이트웨어 IP와 일치한다.

```bash
## ip netns exec snat-e602072f-be51-4c08-9709-135623c0e03b route (controller1 node)
$ ip netns exec snat-e602072f-be51-4c08-9709-135623c0e03b route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         192.168.122.1   0.0.0.0         UG    0      0        0 qg-f803b8a7-5c
link-local      0.0.0.0         255.255.255.0   U     0      0        0 ha-865ebec3-c5
169.254.192.0   0.0.0.0         255.255.192.0   U     0      0        0 ha-865ebec3-c5
192.168.122.0   0.0.0.0         255.255.255.0   U     0      0        0 qg-f803b8a7-5c
```

2개의 NIC이 있으며, ha-865ebec3-c5는 2개의 주소(169.254.192.242/18, 169.254.0.70/24)가 할당되어 있다.

```bash
## ip netns exec snat-e602072f-be51-4c08-9709-135623c0e03b ip address (controller1 node)
$ ip netns exec snat-e602072f-be51-4c08-9709-135623c0e03b ip address
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
231: ha-865ebec3-c5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether fa:16:3e:21:41:49 brd ff:ff:ff:ff:ff:ff
    inet 169.254.192.242/18 brd 169.254.255.255 scope global ha-865ebec3-c5
       valid_lft forever preferred_lft forever
    inet 169.254.0.70/24 scope global ha-865ebec3-c5
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fe21:4149/64 scope link
       valid_lft forever preferred_lft forever
232: qg-f803b8a7-5c: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether fa:16:3e:8a:2b:83 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.156/24 scope global qg-f803b8a7-5c
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fe8a:2b83/64 scope link nodad
       valid_lft forever preferred_lft forever
```

iptables의 nat 테이블에 SNAT 관련 Rule을 확인할 수 있다.

```bash
## ip netns exec snat-e602072f-be51-4c08-9709-135623c0e03b iptables-save (controller1 node)
$ ip netns exec snat-e602072f-be51-4c08-9709-135623c0e03b iptables-save
# Generated by iptables-save v1.8.4 on Tue Oct 17 05:49:40 2023
*raw
:PREROUTING ACCEPT [1228:817147]
:OUTPUT ACCEPT [213:8748]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A OUTPUT -j neutron-l3-agent-OUTPUT
COMMIT
# Completed on Tue Oct 17 05:49:40 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 05:49:40 2023
*nat
:PREROUTING ACCEPT [1015:808399]
:INPUT ACCEPT [1:40]
:OUTPUT ACCEPT [4:246]
:POSTROUTING ACCEPT [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-POSTROUTING - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
:neutron-l3-agent-float-snat - [0:0]
:neutron-l3-agent-snat - [0:0]
:neutron-postrouting-bottom - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A POSTROUTING -j neutron-l3-agent-POSTROUTING
-A POSTROUTING -j neutron-postrouting-bottom
-A neutron-l3-agent-POSTROUTING ! -o qg-f803b8a7-5c -m conntrack ! --ctstate DNAT -j ACCEPT
-A neutron-l3-agent-snat -j neutron-l3-agent-float-snat
-A neutron-l3-agent-snat -o qg-f803b8a7-5c -j SNAT --to-source 192.168.122.156 --random-fully
-A neutron-l3-agent-snat -m mark ! --mark 0x2/0xffff -m conntrack --ctstate DNAT -j SNAT --to-source 192.168.122.156 --random-fully
-A neutron-postrouting-bottom -m comment --comment "Perform source NAT on outgoing traffic." -j neutron-l3-agent-snat
COMMIT
# Completed on Tue Oct 17 05:49:40 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 05:49:40 2023
*mangle
:PREROUTING ACCEPT [1227:817107]
:INPUT ACCEPT [214:8788]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [213:8748]
:POSTROUTING ACCEPT [213:8748]
:neutron-l3-agent-FORWARD - [0:0]
:neutron-l3-agent-INPUT - [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-POSTROUTING - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
:neutron-l3-agent-float-snat - [0:0]
:neutron-l3-agent-floatingip - [0:0]
:neutron-l3-agent-mark - [0:0]
:neutron-l3-agent-scope - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A INPUT -j neutron-l3-agent-INPUT
-A FORWARD -j neutron-l3-agent-FORWARD
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A POSTROUTING -j neutron-l3-agent-POSTROUTING
-A neutron-l3-agent-POSTROUTING -o qg-f803b8a7-5c -m connmark --mark 0x0/0xffff0000 -j CONNMARK --save-mark --nfmask 0xffff0000 --ctmask 0xffff0000
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-mark
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-scope
-A neutron-l3-agent-PREROUTING -m connmark ! --mark 0x0/0xffff0000 -j CONNMARK --restore-mark --nfmask 0xffff0000 --ctmask 0xffff0000
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-floatingip
-A neutron-l3-agent-float-snat -m connmark --mark 0x0/0xffff0000 -j CONNMARK --save-mark --nfmask 0xffff0000 --ctmask 0xffff0000
-A neutron-l3-agent-mark -i qg-f803b8a7-5c -j MARK --set-xmark 0x2/0xffff
-A neutron-l3-agent-scope -i qg-f803b8a7-5c -j MARK --set-xmark 0x4000000/0xffff0000
COMMIT
# Completed on Tue Oct 17 05:49:40 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 05:49:40 2023
*filter
:INPUT ACCEPT [214:8788]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [213:8748]
:neutron-filter-top - [0:0]
:neutron-l3-agent-FORWARD - [0:0]
:neutron-l3-agent-INPUT - [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-local - [0:0]
:neutron-l3-agent-scope - [0:0]
-A INPUT -j neutron-l3-agent-INPUT
-A FORWARD -j neutron-filter-top
-A FORWARD -j neutron-l3-agent-FORWARD
-A OUTPUT -j neutron-filter-top
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A neutron-filter-top -j neutron-l3-agent-local
-A neutron-l3-agent-FORWARD -j neutron-l3-agent-scope
COMMIT
# Completed on Tue Oct 17 05:49:40 2023
*nat
...
-A neutron-l3-agent-snat -o qg-f803b8a7-5c -j SNAT --to-source 192.168.122.156 --random-fully
-A neutron-l3-agent-snat -m mark ! --mark 0x2/0xffff -m conntrack --ctstate DNAT -j SNAT --to-source 192.168.122.156 --random-fully
...
```

### 2.3.4 qrouter-\* Network Namespace

해당 Network Namespace의 route, ip address, iptables-save 를 확인한다.

```bash
## ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b route (controller1 node)
$ ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
169.254.121.82  0.0.0.0         255.255.255.254 U     0      0        0 rfp-e602072f-b
```

rfp-e602072f-b에 하나의 주소(169.254.121.82/31)가 할당되어 있다.

```bash
## ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b ip address (controller1 node)
$ ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b ip address
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: rfp-e602072f-b@if12: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 4a:34:6d:bc:51:8c brd ff:ff:ff:ff:ff:ff link-netns fip-916c7a3e-4c87-40d2-afe8-ae7ff961e19b
    inet 169.254.121.82/31 scope global rfp-e602072f-b
       valid_lft forever preferred_lft forever
```

iptables의 nat 테이블에 REDIRECT 관련 Rule을 확인할 수 있다.

```bash
## ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b iptables-save (controller1 node)
$ ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b iptables-save
# Generated by iptables-save v1.8.4 on Tue Oct 17 05:51:34 2023
*raw
:PREROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A OUTPUT -j neutron-l3-agent-OUTPUT
COMMIT
# Completed on Tue Oct 17 05:51:34 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 05:51:34 2023
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-POSTROUTING - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
:neutron-l3-agent-float-snat - [0:0]
:neutron-l3-agent-snat - [0:0]
:neutron-postrouting-bottom - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A POSTROUTING -j neutron-l3-agent-POSTROUTING
-A POSTROUTING -j neutron-postrouting-bottom
-A neutron-l3-agent-PREROUTING -d 169.254.169.254/32 -i qr-+ -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 9697
-A neutron-postrouting-bottom -m comment --comment "Perform source NAT on outgoing traffic." -j neutron-l3-agent-snat
COMMIT
# Completed on Tue Oct 17 05:51:34 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 05:51:34 2023
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:neutron-l3-agent-FORWARD - [0:0]
:neutron-l3-agent-INPUT - [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-POSTROUTING - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
:neutron-l3-agent-float-snat - [0:0]
:neutron-l3-agent-floatingip - [0:0]
:neutron-l3-agent-mark - [0:0]
:neutron-l3-agent-scope - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A INPUT -j neutron-l3-agent-INPUT
-A FORWARD -j neutron-l3-agent-FORWARD
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A POSTROUTING -j neutron-l3-agent-POSTROUTING
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-mark
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-scope
-A neutron-l3-agent-PREROUTING -m connmark ! --mark 0x0/0xffff0000 -j CONNMARK --restore-mark --nfmask 0xffff0000 --ctmask 0xffff0000
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-floatingip
-A neutron-l3-agent-PREROUTING -d 169.254.169.254/32 -i qr-+ -p tcp -m tcp --dport 80 -j MARK --set-xmark 0x1/0xffff
-A neutron-l3-agent-float-snat -m connmark --mark 0x0/0xffff0000 -j CONNMARK --save-mark --nfmask 0xffff0000 --ctmask 0xffff0000
-A neutron-l3-agent-scope -i rfp-e602072f-b -j MARK --set-xmark 0x4000000/0xffff0000
COMMIT
# Completed on Tue Oct 17 05:51:34 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 05:51:34 2023
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:neutron-filter-top - [0:0]
:neutron-l3-agent-FORWARD - [0:0]
:neutron-l3-agent-INPUT - [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-local - [0:0]
:neutron-l3-agent-scope - [0:0]
-A INPUT -j neutron-l3-agent-INPUT
-A FORWARD -j neutron-filter-top
-A FORWARD -j neutron-l3-agent-FORWARD
-A OUTPUT -j neutron-filter-top
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A neutron-filter-top -j neutron-l3-agent-local
-A neutron-l3-agent-FORWARD -j neutron-l3-agent-scope
-A neutron-l3-agent-INPUT -m mark --mark 0x1/0xffff -j ACCEPT
-A neutron-l3-agent-INPUT -p tcp -m tcp --dport 9697 -j DROP
-A neutron-l3-agent-scope -o rfp-e602072f-b -m mark ! --mark 0x4000000/0xffff0000 -j DROP
COMMIT
# Completed on Tue Oct 17 05:51:34 2023
*nat
...
-A neutron-l3-agent-PREROUTING -d 169.254.169.254/32 -i qr-+ -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 9697
...
```

## 2.4 Router Interface 추가

생성한 Router에 Subnet(CIDR 172.16.31.0/24) 연결을 위한 Interface를 추가한다.

### 2.4.1 ip netns list

추가적으로 생성되는 Network Network Namespace는 없음

### 2.4.2 qdhcp-\* Network Namespace

해당 Network Namespace에 route, ip address, iptables-save에 특별한 변경사항은 없다.

### 2.4.3 snat-\* Network Namespace

해당 Network Namespace의 route, ip address, iptables-save 를 확인한다. 라우팅 테이블에 연결한 Subnet의 CIDR 항목이 추가되었다.

```bash
## ip netns exec snat-e602072f-be51-4c08-9709-135623c0e03b route (controller1 node)
$ ip netns exec snat-e602072f-be51-4c08-9709-135623c0e03b route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         192.168.122.1   0.0.0.0         UG    0      0        0 qg-f803b8a7-5c
link-local      0.0.0.0         255.255.255.0   U     0      0        0 ha-865ebec3-c5
169.254.192.0   0.0.0.0         255.255.192.0   U     0      0        0 ha-865ebec3-c5
172.16.31.0     0.0.0.0         255.255.255.0   U     0      0        0 sg-2f4893af-6b      # 추가
192.168.122.0   0.0.0.0         255.255.255.0   U     0      0        0 qg-f803b8a7-5c
```

sg-2f4893af-6b(172.16.31.183/24)가 추가되어 있다. 라우팅 테이블에 확인했듯이 Subnet 관련 NIC이다.

```bash
## ip netns exec snat-e602072f-be51-4c08-9709-135623c0e03b ip address (controller1 node)
$ ip netns exec snat-e602072f-be51-4c08-9709-135623c0e03b ip address
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
231: ha-865ebec3-c5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether fa:16:3e:21:41:49 brd ff:ff:ff:ff:ff:ff
    inet 169.254.192.242/18 brd 169.254.255.255 scope global ha-865ebec3-c5
       valid_lft forever preferred_lft forever
    inet 169.254.0.70/24 scope global ha-865ebec3-c5
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fe21:4149/64 scope link
       valid_lft forever preferred_lft forever
232: qg-f803b8a7-5c: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether fa:16:3e:8a:2b:83 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.156/24 scope global qg-f803b8a7-5c
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fe8a:2b83/64 scope link nodad
       valid_lft forever preferred_lft forever
234: sg-2f4893af-6b: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default qlen 1000     # 추가
    link/ether fa:16:3e:0e:09:fb brd ff:ff:ff:ff:ff:ff
    inet 172.16.31.183/24 scope global sg-2f4893af-6b
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fe0e:9fb/64 scope link
       valid_lft forever preferred_lft forever
```

filter 테이블에 추가항목이 있다.

```bash
## ip netns exec snat-e602072f-be51-4c08-9709-135623c0e03b iptables-save (controller1 node)
$ ip netns exec snat-e602072f-be51-4c08-9709-135623c0e03b iptables-save
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:03:02 2023
*raw
:PREROUTING ACCEPT [3634:2434079]
:OUTPUT ACCEPT [629:25844]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A OUTPUT -j neutron-l3-agent-OUTPUT
COMMIT
# Completed on Tue Oct 17 06:03:02 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:03:02 2023
*nat
:PREROUTING ACCEPT [3011:2408475]
:INPUT ACCEPT [1:40]
:OUTPUT ACCEPT [9:618]
:POSTROUTING ACCEPT [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-POSTROUTING - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
:neutron-l3-agent-float-snat - [0:0]
:neutron-l3-agent-snat - [0:0]
:neutron-postrouting-bottom - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A POSTROUTING -j neutron-l3-agent-POSTROUTING
-A POSTROUTING -j neutron-postrouting-bottom
-A neutron-l3-agent-POSTROUTING ! -o qg-f803b8a7-5c -m conntrack ! --ctstate DNAT -j ACCEPT
-A neutron-l3-agent-snat -j neutron-l3-agent-float-snat
-A neutron-l3-agent-snat -o qg-f803b8a7-5c -j SNAT --to-source 192.168.122.156 --random-fully
-A neutron-l3-agent-snat -m mark ! --mark 0x2/0xffff -m conntrack --ctstate DNAT -j SNAT --to-source 192.168.122.156 --random-fully
-A neutron-postrouting-bottom -m comment --comment "Perform source NAT on outgoing traffic." -j neutron-l3-agent-snat
COMMIT
# Completed on Tue Oct 17 06:03:02 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:03:02 2023
*mangle
:PREROUTING ACCEPT [1431:959519]
:INPUT ACCEPT [247:10336]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [253:10576]
:POSTROUTING ACCEPT [253:10576]
:neutron-l3-agent-FORWARD - [0:0]
:neutron-l3-agent-INPUT - [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-POSTROUTING - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
:neutron-l3-agent-float-snat - [0:0]
:neutron-l3-agent-floatingip - [0:0]
:neutron-l3-agent-mark - [0:0]
:neutron-l3-agent-scope - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A INPUT -j neutron-l3-agent-INPUT
-A FORWARD -j neutron-l3-agent-FORWARD
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A POSTROUTING -j neutron-l3-agent-POSTROUTING
-A neutron-l3-agent-POSTROUTING -o qg-f803b8a7-5c -m connmark --mark 0x0/0xffff0000 -j CONNMARK --save-mark --nfmask 0xffff0000 --ctmask 0xffff0000
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-mark
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-scope
-A neutron-l3-agent-PREROUTING -m connmark ! --mark 0x0/0xffff0000 -j CONNMARK --restore-mark --nfmask 0xffff0000 --ctmask 0xffff0000
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-floatingip
-A neutron-l3-agent-float-snat -m connmark --mark 0x0/0xffff0000 -j CONNMARK --save-mark --nfmask 0xffff0000 --ctmask 0xffff0000
-A neutron-l3-agent-mark -i qg-f803b8a7-5c -j MARK --set-xmark 0x2/0xffff
-A neutron-l3-agent-scope -i sg-2f4893af-6b -j MARK --set-xmark 0x4000000/0xffff0000        # 추가
-A neutron-l3-agent-scope -i qg-f803b8a7-5c -j MARK --set-xmark 0x4000000/0xffff0000
COMMIT
# Completed on Tue Oct 17 06:03:02 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:03:02 2023
*filter
:INPUT ACCEPT [247:10336]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [253:10576]
:neutron-filter-top - [0:0]
:neutron-l3-agent-FORWARD - [0:0]
:neutron-l3-agent-INPUT - [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-local - [0:0]
:neutron-l3-agent-scope - [0:0]
-A INPUT -j neutron-l3-agent-INPUT
-A FORWARD -j neutron-filter-top
-A FORWARD -j neutron-l3-agent-FORWARD
-A OUTPUT -j neutron-filter-top
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A neutron-filter-top -j neutron-l3-agent-local
-A neutron-l3-agent-FORWARD -j neutron-l3-agent-scope
-A neutron-l3-agent-scope -o sg-2f4893af-6b -m mark ! --mark 0x4000000/0xffff0000 -j DROP       # 추가
COMMIT
# Completed on Tue Oct 17 06:03:02 2023
*filter
...
-A neutron-l3-agent-scope -o sg-2f4893af-6b -m mark ! --mark 0x4000000/0xffff0000 -j DROP       # 추가
...
```

### 2.4.4 qrouter-\* Network Namespace

해당 Network Namespace의 route, ip address, iptables-save 를 확인한다. 여기서도 라우팅 테이블에 연결한 Subnet의 CIDR 항목이 추가되었다.

```bash
## ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b route (controller1 node)
$ ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
169.254.121.82  0.0.0.0         255.255.255.254 U     0      0        0 rfp-e602072f-b
172.16.31.0     0.0.0.0         255.255.255.0   U     0      0        0 qr-e269ebf1-ad          # 추가
```

Subnet 관련 NIC인 qr-e269ebf1-ad(172.16.31.1/24)가 추가되어 있다.

```bash
## ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b ip address (controller1 node)
$ ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b ip address
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: rfp-e602072f-b@if12: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 4a:34:6d:bc:51:8c brd ff:ff:ff:ff:ff:ff link-netns fip-916c7a3e-4c87-40d2-afe8-ae7ff961e19b
    inet 169.254.121.82/31 scope global rfp-e602072f-b
       valid_lft forever preferred_lft forever
233: qr-e269ebf1-ad: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default qlen 1000     # 추가
    link/ether fa:16:3e:d1:57:98 brd ff:ff:ff:ff:ff:ff
    inet 172.16.31.1/24 brd 172.16.31.255 scope global qr-e269ebf1-ad
       valid_lft forever preferred_lft forever
```

filter 테이블에 추가항목이 있다.

```bash
## ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b iptables-save (controller1 node)
$ ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b iptables-save
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:05:22 2023
*raw
:PREROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A OUTPUT -j neutron-l3-agent-OUTPUT
COMMIT
# Completed on Tue Oct 17 06:05:22 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:05:22 2023
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-POSTROUTING - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
:neutron-l3-agent-float-snat - [0:0]
:neutron-l3-agent-snat - [0:0]
:neutron-postrouting-bottom - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A POSTROUTING -j neutron-l3-agent-POSTROUTING
-A POSTROUTING -j neutron-postrouting-bottom
-A neutron-l3-agent-PREROUTING -d 169.254.169.254/32 -i qr-+ -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 9697
-A neutron-postrouting-bottom -m comment --comment "Perform source NAT on outgoing traffic." -j neutron-l3-agent-snat
COMMIT
# Completed on Tue Oct 17 06:05:22 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:05:22 2023
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:neutron-l3-agent-FORWARD - [0:0]
:neutron-l3-agent-INPUT - [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-POSTROUTING - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
:neutron-l3-agent-float-snat - [0:0]
:neutron-l3-agent-floatingip - [0:0]
:neutron-l3-agent-mark - [0:0]
:neutron-l3-agent-scope - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A INPUT -j neutron-l3-agent-INPUT
-A FORWARD -j neutron-l3-agent-FORWARD
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A POSTROUTING -j neutron-l3-agent-POSTROUTING
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-mark
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-scope
-A neutron-l3-agent-PREROUTING -m connmark ! --mark 0x0/0xffff0000 -j CONNMARK --restore-mark --nfmask 0xffff0000 --ctmask 0xffff0000
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-floatingip
-A neutron-l3-agent-PREROUTING -d 169.254.169.254/32 -i qr-+ -p tcp -m tcp --dport 80 -j MARK --set-xmark 0x1/0xffff
-A neutron-l3-agent-float-snat -m connmark --mark 0x0/0xffff0000 -j CONNMARK --save-mark --nfmask 0xffff0000 --ctmask 0xffff0000
-A neutron-l3-agent-scope -i qr-e269ebf1-ad -j MARK --set-xmark 0x4000000/0xffff0000        # 추가
-A neutron-l3-agent-scope -i rfp-e602072f-b -j MARK --set-xmark 0x4000000/0xffff0000
COMMIT
# Completed on Tue Oct 17 06:05:22 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:05:22 2023
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:neutron-filter-top - [0:0]
:neutron-l3-agent-FORWARD - [0:0]
:neutron-l3-agent-INPUT - [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-local - [0:0]
:neutron-l3-agent-scope - [0:0]
-A INPUT -j neutron-l3-agent-INPUT
-A FORWARD -j neutron-filter-top
-A FORWARD -j neutron-l3-agent-FORWARD
-A OUTPUT -j neutron-filter-top
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A neutron-filter-top -j neutron-l3-agent-local
-A neutron-l3-agent-FORWARD -j neutron-l3-agent-scope
-A neutron-l3-agent-INPUT -m mark --mark 0x1/0xffff -j ACCEPT
-A neutron-l3-agent-INPUT -p tcp -m tcp --dport 9697 -j DROP
-A neutron-l3-agent-scope -o qr-e269ebf1-ad -m mark ! --mark 0x4000000/0xffff0000 -j DROP       # 추가
-A neutron-l3-agent-scope -o rfp-e602072f-b -m mark ! --mark 0x4000000/0xffff0000 -j DROP
COMMIT
# Completed on Tue Oct 17 06:05:22 2023
*filter
...
-A neutron-l3-agent-scope -o qr-e269ebf1-ad -m mark ! --mark 0x4000000/0xffff0000 -j DROP       # 추가
...
```

## 2.5 VM 생성

생성한 Subnet(172.16.31.0/24)에 VM(172.16.31.186)을 생성한다.

### 2.5.1 ip netns list

Controller Node에 추가로 생성되는 Network Namespace는 없으나, Compute Node에 Network Namespace가 하나 생성된다.

```bash
## ip netns list (controller1 node/compute1 node)
## controller1 node
$ ip netns list
qrouter-e602072f-be51-4c08-9709-135623c0e03b (id: 42)
snat-e602072f-be51-4c08-9709-135623c0e03b (id: 41)
qdhcp-c926d8cb-0b16-474c-96d3-4a0646096be3 (id: 6)

## compute1 node
$ ip netns list
qrouter-e602072f-be51-4c08-9709-135623c0e03b (id: 3)        # 생성
```

### 2.5.2 qdhcp-\* Network Namespace

해당 Network Namespace에 route, ip address, iptables-save에 특별한 변경사항은 없다.

### 2.5.3 snat-\* Network Namespace

해당 Network Namespace에 route, ip address, iptables-save에 특별한 변경사항은 없다.

### 2.5.4 qrouter-\* Network Namespace (Controller Node)

해당 Network Namespace에 route, ip address, iptables-save에 특별한 변경사항은 없다.

### 2.5.5 qrouter-\* Network Namespace (Compute Node)

해당 Network Namespace의 route, ip address, iptables-save 를 확인한다. Subnet의 CIDR 항목이 있다.

```bash
## ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b route (compute1 node)
$ ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
169.254.93.38   0.0.0.0         255.255.255.254 U     0      0        0 rfp-e602072f-b
172.16.31.0     0.0.0.0         255.255.255.0   U     0      0        0 qr-e269ebf1-ad
```

2개의 NIC이 있으며, qr-e269ebf1-ad(172.16.31.1/24)가 Subnet과 관련된 NIC이다.

```bash
## ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b ip address (compute1 node)
$ ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b ip address
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: rfp-e602072f-b@if7: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether c2:53:25:97:06:2a brd ff:ff:ff:ff:ff:ff link-netns fip-916c7a3e-4c87-40d2-afe8-ae7ff961e19b
    inet 169.254.93.38/31 scope global rfp-e602072f-b
       valid_lft forever preferred_lft forever
    inet6 fe80::c053:25ff:fe97:62a/64 scope link
       valid_lft forever preferred_lft forever
239: qr-e269ebf1-ad: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether fa:16:3e:d1:57:98 brd ff:ff:ff:ff:ff:ff
    inet 172.16.31.1/24 brd 172.16.31.255 scope global qr-e269ebf1-ad
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fed1:5798/64 scope link
       valid_lft forever preferred_lft forever
```

nat 테이블에 REDIRECT 관련 Rule이 있다.

```bash
## ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b iptables-save (compute1 node)
$ ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b iptables-save
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:29:48 2023
*raw
:PREROUTING ACCEPT [101:7800]
:OUTPUT ACCEPT [61:5515]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A OUTPUT -j neutron-l3-agent-OUTPUT
COMMIT
# Completed on Tue Oct 17 06:29:48 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:29:48 2023
*nat
:PREROUTING ACCEPT [4:556]
:INPUT ACCEPT [17:1312]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [2:144]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-POSTROUTING - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
:neutron-l3-agent-float-snat - [0:0]
:neutron-l3-agent-snat - [0:0]
:neutron-postrouting-bottom - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A POSTROUTING -j neutron-l3-agent-POSTROUTING
-A POSTROUTING -j neutron-postrouting-bottom
-A neutron-l3-agent-PREROUTING -d 169.254.169.254/32 -i qr-+ -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 9697
-A neutron-postrouting-bottom -m comment --comment "Perform source NAT on outgoing traffic." -j neutron-l3-agent-snat
COMMIT
# Completed on Tue Oct 17 06:29:48 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:29:48 2023
*mangle
:PREROUTING ACCEPT [101:7800]
:INPUT ACCEPT [93:7257]
:FORWARD ACCEPT [8:543]
:OUTPUT ACCEPT [61:5515]
:POSTROUTING ACCEPT [69:6058]
:neutron-l3-agent-FORWARD - [0:0]
:neutron-l3-agent-INPUT - [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-POSTROUTING - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
:neutron-l3-agent-float-snat - [0:0]
:neutron-l3-agent-floatingip - [0:0]
:neutron-l3-agent-mark - [0:0]
:neutron-l3-agent-scope - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A INPUT -j neutron-l3-agent-INPUT
-A FORWARD -j neutron-l3-agent-FORWARD
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A POSTROUTING -j neutron-l3-agent-POSTROUTING
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-mark
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-scope
-A neutron-l3-agent-PREROUTING -m connmark ! --mark 0x0/0xffff0000 -j CONNMARK --restore-mark --nfmask 0xffff0000 --ctmask 0xffff0000
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-floatingip
-A neutron-l3-agent-PREROUTING -d 169.254.169.254/32 -i qr-+ -p tcp -m tcp --dport 80 -j MARK --set-xmark 0x1/0xffff
-A neutron-l3-agent-float-snat -m connmark --mark 0x0/0xffff0000 -j CONNMARK --save-mark --nfmask 0xffff0000 --ctmask 0xffff0000
-A neutron-l3-agent-scope -i qr-e269ebf1-ad -j MARK --set-xmark 0x4000000/0xffff0000
-A neutron-l3-agent-scope -i rfp-e602072f-b -j MARK --set-xmark 0x4000000/0xffff0000
COMMIT
# Completed on Tue Oct 17 06:29:48 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:29:48 2023
*filter
:INPUT ACCEPT [3:742]
:FORWARD ACCEPT [8:543]
:OUTPUT ACCEPT [61:5515]
:neutron-filter-top - [0:0]
:neutron-l3-agent-FORWARD - [0:0]
:neutron-l3-agent-INPUT - [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-local - [0:0]
:neutron-l3-agent-scope - [0:0]
-A INPUT -j neutron-l3-agent-INPUT
-A FORWARD -j neutron-filter-top
-A FORWARD -j neutron-l3-agent-FORWARD
-A OUTPUT -j neutron-filter-top
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A neutron-filter-top -j neutron-l3-agent-local
-A neutron-l3-agent-FORWARD -j neutron-l3-agent-scope
-A neutron-l3-agent-INPUT -m mark --mark 0x1/0xffff -j ACCEPT
-A neutron-l3-agent-INPUT -p tcp -m tcp --dport 9697 -j DROP
-A neutron-l3-agent-scope -o qr-e269ebf1-ad -m mark ! --mark 0x4000000/0xffff0000 -j DROP
-A neutron-l3-agent-scope -o rfp-e602072f-b -m mark ! --mark 0x4000000/0xffff0000 -j DROP
COMMIT
# Completed on Tue Oct 17 06:29:48 2023
*nat
...
-A neutron-l3-agent-PREROUTING -d 169.254.169.254/32 -i qr-+ -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 9697
...
```

## 2.6 Floating IP 연결

생성한 VM(172.16.31.186)에 Floating IP(192.168.122.178)를 연결한다.

### 2.6.1 ip netns list

추가적으로 생성되는 Network Network Namespace는 없음

### 2.6.2 qdhcp-\* Network Namespace

해당 Network Namespace에 route, ip address, iptables-save에 특별한 변경사항은 없다.

### 2.6.3 snat-\* Network Namespace

해당 Network Namespace에 route, ip address, iptables-save에 특별한 변경사항은 없다.

### 2.6.4 qrouter-\* Network Namespace (Controller Node)

해당 Network Namespace에 route, ip address, iptables-save에 특별한 변경사항은 없다.

### 2.6.5 qrouter-\* Network Namespace (Compute Node)

해당 Network Namespace에 route, ip address에는 특별한 변경사항이 없으나, iptables-save의 nat 테이블에 변동사항이 발생하였다.

```bash
## ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b iptables-save (compute1 node)
$ ip netns exec qrouter-e602072f-be51-4c08-9709-135623c0e03b iptables-save
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:50:50 2023
*raw
:PREROUTING ACCEPT [224:22255]
:OUTPUT ACCEPT [61:5515]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A OUTPUT -j neutron-l3-agent-OUTPUT
COMMIT
# Completed on Tue Oct 17 06:50:50 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:50:50 2023
*nat
:PREROUTING ACCEPT [1:84]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [1:60]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-POSTROUTING - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
:neutron-l3-agent-float-snat - [0:0]
:neutron-l3-agent-snat - [0:0]
:neutron-postrouting-bottom - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A POSTROUTING -j neutron-l3-agent-POSTROUTING
-A POSTROUTING -j neutron-postrouting-bottom
-A neutron-l3-agent-POSTROUTING ! -o rfp-e602072f-b -m conntrack ! --ctstate DNAT -j ACCEPT                         # 추가
-A neutron-l3-agent-PREROUTING -d 169.254.169.254/32 -i qr-+ -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 9697
-A neutron-l3-agent-PREROUTING -d 192.168.122.178/32 -i rfp-e602072f-b -j DNAT --to-destination 172.16.31.186       # 추가
-A neutron-l3-agent-float-snat -s 172.16.31.186/32 -j SNAT --to-source 192.168.122.178 --random-fully               # 추가
-A neutron-l3-agent-snat -j neutron-l3-agent-float-snat                                                             # 추가
-A neutron-postrouting-bottom -m comment --comment "Perform source NAT on outgoing traffic." -j neutron-l3-agent-snat
COMMIT
# Completed on Tue Oct 17 06:50:50 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:50:50 2023
*mangle
:PREROUTING ACCEPT [224:22255]
:INPUT ACCEPT [93:7257]
:FORWARD ACCEPT [131:14998]
:OUTPUT ACCEPT [61:5515]
:POSTROUTING ACCEPT [192:20513]
:neutron-l3-agent-FORWARD - [0:0]
:neutron-l3-agent-INPUT - [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-POSTROUTING - [0:0]
:neutron-l3-agent-PREROUTING - [0:0]
:neutron-l3-agent-float-snat - [0:0]
:neutron-l3-agent-floatingip - [0:0]
:neutron-l3-agent-mark - [0:0]
:neutron-l3-agent-scope - [0:0]
-A PREROUTING -j neutron-l3-agent-PREROUTING
-A INPUT -j neutron-l3-agent-INPUT
-A FORWARD -j neutron-l3-agent-FORWARD
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A POSTROUTING -j neutron-l3-agent-POSTROUTING
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-mark
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-scope
-A neutron-l3-agent-PREROUTING -m connmark ! --mark 0x0/0xffff0000 -j CONNMARK --restore-mark --nfmask 0xffff0000 --ctmask 0xffff0000
-A neutron-l3-agent-PREROUTING -j neutron-l3-agent-floatingip
-A neutron-l3-agent-PREROUTING -d 169.254.169.254/32 -i qr-+ -p tcp -m tcp --dport 80 -j MARK --set-xmark 0x1/0xffff
-A neutron-l3-agent-float-snat -m connmark --mark 0x0/0xffff0000 -j CONNMARK --save-mark --nfmask 0xffff0000 --ctmask 0xffff0000
-A neutron-l3-agent-scope -i qr-e269ebf1-ad -j MARK --set-xmark 0x4000000/0xffff0000
-A neutron-l3-agent-scope -i rfp-e602072f-b -j MARK --set-xmark 0x4000000/0xffff0000
COMMIT
# Completed on Tue Oct 17 06:50:50 2023
# Generated by iptables-save v1.8.4 on Tue Oct 17 06:50:50 2023
*filter
:INPUT ACCEPT [3:742]
:FORWARD ACCEPT [131:14998]
:OUTPUT ACCEPT [61:5515]
:neutron-filter-top - [0:0]
:neutron-l3-agent-FORWARD - [0:0]
:neutron-l3-agent-INPUT - [0:0]
:neutron-l3-agent-OUTPUT - [0:0]
:neutron-l3-agent-local - [0:0]
:neutron-l3-agent-scope - [0:0]
-A INPUT -j neutron-l3-agent-INPUT
-A FORWARD -j neutron-filter-top
-A FORWARD -j neutron-l3-agent-FORWARD
-A OUTPUT -j neutron-filter-top
-A OUTPUT -j neutron-l3-agent-OUTPUT
-A neutron-filter-top -j neutron-l3-agent-local
-A neutron-l3-agent-FORWARD -j neutron-l3-agent-scope
-A neutron-l3-agent-INPUT -m mark --mark 0x1/0xffff -j ACCEPT
-A neutron-l3-agent-INPUT -p tcp -m tcp --dport 9697 -j DROP
-A neutron-l3-agent-scope -o qr-e269ebf1-ad -m mark ! --mark 0x4000000/0xffff0000 -j DROP
-A neutron-l3-agent-scope -o rfp-e602072f-b -m mark ! --mark 0x4000000/0xffff0000 -j DROP
COMMIT
# Completed on Tue Oct 17 06:50:50 2023
*nat
-A neutron-l3-agent-POSTROUTING ! -o rfp-e602072f-b -m conntrack ! --ctstate DNAT -j ACCEPT                         # 추가
...
-A neutron-l3-agent-PREROUTING -d 192.168.122.178/32 -i rfp-e602072f-b -j DNAT --to-destination 172.16.31.186       # 추가
-A neutron-l3-agent-float-snat -s 172.16.31.186/32 -j SNAT --to-source 192.168.122.178 --random-fully               # 추가
-A neutron-l3-agent-snat -j neutron-l3-agent-float-snat                                                             # 추가
...
```
